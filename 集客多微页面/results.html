<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=0.33333,minimum-scale=0.33333,maximum-scale=0.33333" />
    <title>比赛结果</title>
    <script src="./js/jquery-2.1.0.js"></script>
    <link rel="stylesheet" href="css/results.css">
    <script>
        //1.获取像素比
        var pixelRatio=1/window.devicePixelRatio;
        // console.log(pixelRatio);
        //2.通过js动态来设置视口
        document.write('<meta name="viewport" content="width=device-width,initial-scale='+pixelRatio+',minimum-scale='+pixelRatio*2+',maximum-scale='+pixelRatio+'">');
        //3.获取html节点
        var html=document.getElementsByTagName('html')[0];
        //console.log(html)
        //4.获取屏幕宽度
        var pageWidth=html.getBoundingClientRect().width;
        // console.log(pageWidth);
        //屏幕宽度/固定数值=基准值;
        html.style.fontSize=pageWidth/15+'px';
</script>
</head>
<body>
    <!--灯光  -->
    <div class="deng">
        <img src="img/dengguang.png" alt="error">
    </div>
    <!--帘子  -->
    <div class="lian">
        <img src="img/lian.png" alt="error">
    </div>
    <div class="main">
        <img src="img/zu@2x_33.png" alt="error">
    </div>
    <!--比赛结果图标  -->
    <div class="jieguo">
        <img src="img/jieguo.png" alt="error" style="width:100%;height:100%">
    </div>
    <!--比赛奖品图标  -->
    <div class="jiangpin">
        <img src="img/jiangpin.png" alt="error" style="width:100%;height:100%">
    </div>
    <!--展示结果  -->
    <div class="showmain">
        <div class="matchshow">
            <div class="showimg1">
                <img src="img/peo.png" alt="error" style="width:1.2rem;;height:1.2rem;">
            </div>
            <div class="showimg2">
                <img src="img/gg.png" alt="error" style="width: .8rem;;height: .8rem;">
            </div>
            <div class="showimg3">
                
            </div>
            <div class="showimg4">
                
            </div>
            <div class="showimg5">
                
            </div>
        </div>
        <div class="matchshow">
            <div class="showimg1">
                <img src="img/peo.png" alt="error" style="width:1.2rem;;height:1.2rem;">
            </div>
            <div class="showimg2">
                <img src="img/gg.png" alt="error" style="width: .8rem;;height: .8rem;">
            </div>
            <div class="showimg3">
                
            </div>
            <div class="showimg4">
                
            </div>
            <div class="showimg5">
                 
            </div>
        </div>
        <div class="matchshow">
            <div class="showimg1">
                <img src="img/peo.png" alt="error" style="width:1.2rem;;height:1.2rem;">
            </div>
            <div class="showimg2">
                <img src="img/gg.png" alt="error" style="width: .8rem;;height: .8rem;">
            </div>
            <div class="showimg3">
                
            </div>
            <div class="showimg4">
                
            </div>
            <div class="showimg5">
                
            </div>
        </div>
        <div class="matchshow">
            <div class="showimg1">
                <img src="img/peo.png" alt="error" style="width:1.2rem;;height:1.2rem;">
            </div>
            <div class="showimg2">
                <img src="img/gg.png" alt="error" style="width: .8rem;;height: .8rem;">
            </div>
            <div class="showimg3">
                
            </div>
            <div class="showimg4">
                
            </div>
            <div class="showimg5">
                
            </div>
        </div>
    </div>
 
    <!--奖杯  -->
    <!-- <div class="imglist">
        <div class="img1 pic" style="display:none">
            <img src="img/gg.png" alt="">
        </div>
        <div class="img1 pic" style="display:none">
            <img src="img/gg.png" alt="">
        </div>
        <div class="img1 pic" style="display:none">
            <img src="img/gg.png" alt="">
        </div>
        <div class="img1 pic" style="display:none">
            <img src="img/gg.png" alt="">
        </div>
    </div> -->
    <!--名次  -->
    <!-- <div class="sortlist">
        <div class="a1 sort"></div>
        <div class="a1 sort"></div>
        <div class="a1 sort"></div>
        <div class="a1 sort"></div>
    </div> -->
    <!--姓名  -->
    <!-- <div class="lisName">
        <div class="a kname"></div>
        <div class="b kname"></div>
        <div class="c kname"></div>
        <div class="d kname"></div>
    </div> -->
    <!--体重  -->
    <!-- <div class="lisWei">
        <div class="e kwei"></div>
        <div class="f kwei"></div>
        <div class="g kwei"></div>
        <div class="h kwei"></div>
    </div> -->
    <!--奖励图片  -->
    <div class="preImg">
        <img class="iimg" src=" ">
    </div>
    <!--领取  -->
    <div class="get" onclick="getPresent()">
        <img src="img/kb2@2x_33.png" alt="error">
    </div>
    <!--注册  -->
    <div class="registered" style="display:none">
        <div class="name"></div>
        <!--关闭  -->
        <div class="close" onclick="closeDiv()">
            <img src="img/close@2x.png" alt="error">
        </div>
        <hr>
        <!--手机号  -->
        <input id="phone" type="text" class="phone" placeholder="请输入手机号">
        <!--验证码  -->
        <input id="phone_code" class="number" type="number" placeholder="请输入验证码">
        <div id="btn" class="keyNum" onclick="settime(this)">获取验证码</div>
        <!--确认注册  -->
        <div class="sure" onclick="getTip()">确认</div>
    </div>
    <div id="div_alert"></div>
    <script>
        //获取URL上参数
        function getUrlPara(paraName) {
                var reg = new RegExp("(^|&)" + paraName + "=([^&]*)(&|$)", "i");
                var r = window.location.search.substr(1).match(reg);
                if (r != null) return unescape(r[2]);
                return null;    
        }
        // 初始化接口
        var storeId = null
        var activityId = getUrlPara("activityId");
        $.post("/clt/index.json?a=v1/activityInfo", {
            isH5Test : true,
            activityId : activityId,
        },function(data){
            console.log(data)
            // 记录下storedId
            storeId = data.data.storeId
            //  串联数据
            if(data.playerList.length > 0 ){
                // 注册框姓名
                $(".name").html(data.data.userName==''?'':data.data.userName+',请先完成手机验证')
                // 姓名
                var a
                var name = document.getElementsByClassName('showimg4')
                for(a=0;a<data.playerList.length;a++){
                    if(data.playerList[a].playerName){
                        name[a].innerHTML= data.playerList[a].playerName
                    }
                }

                // 个数
                var b
                var keynum = document.getElementsByClassName('showimg5')
                for(b=0;b<data.playerList.length;b++){
                    if(data.playerList[b].playerName){
                        keynum[b].innerHTML= data.playerList[b].achieveNum + '个'
                    }
                }
                
                //名次/奖杯
                var e
                var sortlist = document.getElementsByClassName('showimg3')
                var littleimglist = document.getElementsByClassName('showimg2')
                console.log(sortlist)
                for(e=0;e<data.playerList.length;e++){
                    if(data.playerList[e].sort == 1){
                        sortlist[e].innerHTML = '第一名'
                    }else if(data.playerList[e].sort == 2){
                        sortlist[e].innerHTML = '第二名'
                        littleimglist[e].innerHTML =  ''
                    }else if(data.playerList[e].sort == 3){
                        sortlist[e].innerHTML = '第三名'
                        littleimglist[e].innerHTML =  ''
                    }else if(data.playerList[e].sort == 4){
                        sortlist[e].innerHTML = '第四名'
                        littleimglist[e].innerHTML =  ''
                    }
                }
                // 获得的奖励图片
                var man = data.data.votePlayerId  //用户投票选择的选手
                var url1 = "./img/ysimg.png"
                var url2 = "./img/cyimg.png"
                console.log(man)
                if(data.playerList[0].sort == data.playerList[1].sort){   
                    if(man == data.playerList[0].playerId || man == data.playerList[1].playerId){  //显示大奖
                        $('.iimg').attr("src",url1); 
                    }else{
                        $('.iimg').attr("src",url2);
                    }
                }else{           //显示参与奖
                    if(man == data.playerList[0].playerId){
                        $('.iimg').attr("src",url1);
                    }else{
                        $('.iimg').attr("src",url2);
                    }
                }
                // 选择的选手高亮
                var i 
                var writeKey = null
                for(i =0 ;i<data.playerList.length;i++){
                    if(data.playerList[i].playerId == data.data.votePlayerId){
                        writeKey = i
                        // 变换颜色
                        sortlist[writeKey].style.color = "yellow"
                        name[writeKey].style.color = "yellow"
                        keynum[writeKey].style.color = "yellow"
                    }
                }
            }else{
                alert('数据获取失败 请检查网络并重试')
            }
        }, "json");

        // 领取优惠奖励接口
        function getPresent(){
            // 判断是否是卖家
            var activityId = getUrlPara("activityId");
            $.post("/clt/activity/getActivityAward.msp", {
                isH5Test : true,
                activityId : activityId,
            },function(data){
                // 优先判断是否是卖家
                if(data){
                    if(data.code == 1){  //可直接领取
                        window.location.replace ( 'inAgentSuccb.html')
                    }else if(data.code == 0){ //显示提示
                        alert(data.msg)
                    }else if(data.code == 2){ //唤醒注册
                        $(".registered").show();
                    }else{
                        alert(data.msg)
                    }
                }else{
                    alert('数据获取失败 请检查网络并重试')
                }
            }, "json");
        }
        // 关闭注册弹窗
        function closeDiv(){
            $(".registered").hide();
        }
        // 确认注册
        function getTip(){
            var code = $("#phone_code").val()
            var mobile = $("#phone").val()
            if( code.length == 6){
                // $(".registered").hide();
                // $("#div_alert").html("注册成功")
                // tanchuang();

                // 验证注册
                $.post("/clt/wap/userRegister.msp", {
                    isH5Test : true,
                    storeId : storeId,
                    mobile : mobile,
                    smsCode : code,
                },function(data){
                    if(data){
                    
                        if(data.code == 1){
                            $(".registered").hide();
                            $("#div_alert").html(data.msg)
                            tanchuang();
                            window.location.replace ( 'inAgentSuccb.html')  //领取成功直接跳转
                        }else{
                            $("#div_alert").html(data.msg);
                            tanchuang();
                        }
                    }else{
                        $("#div_alert").html("获取接口失败 请重试");
                        tanchuang();
                    }
                }, "json");
            }else{
                $("#div_alert").html("请验证输入是否正确");
                tanchuang();
            }
        }
            

        
        //小弹窗
        function tanchuang(){
                var cler;
                var i = 0;
                var count = 5;
                if (cler!= null && cler!= undefined) {
                    window.clearInterval(cler);
                }
                // $("#div_alert").html("");
                $("#div_alert").fadeIn();
                i = 0;
                var tcount = 2;
                count = tcount;
                timerun();
                function timerun() {
                    if (i >= count) {
                        // document.getElementById("div_alert").style.display = "none";
                        $("#div_alert").fadeOut();
                        window.clearInterval(cler);
                    }else {
                        cler = window.setTimeout(timerun, 900);
                    }
                    i++;
                }
        }
        // 验证码
        
        var countdown = 60;             //验证码初始
        var userid = getUrlPara("userid");
        var phone = $("#phone").val();

        var timeoutKey = 0;                               //倒计时控制变量
        var linkKey = 1;                                  //接口控制变量

        function settime(obj) {

            var area_code = 86;
            var phone = $("#phone").val();
            
            if (phone =='') {                                           //如果输入为空
                $("#div_alert").html("请输入手机号");
                tanchuang();
                $('#phone').focus();
                return false;
            }

            // if (area_code == "86") {
            //     if (!phone.match(/^1[3|4|5|7|8][0-9]{9}$/)) {           //检查手机号格式
            //         // $("#div_alert").html("请输入正确的手机号");           //恢复默认样式
            //         // tanchuang();
            //         // alert('请输入正确的手机号')
            //         $("#div_alert").html("请输入正确的手机号");
            //         tanchuang();
            //         timeoutKey = 0              //关闭倒计时
            //         linkKey = 1                 //开启接口
            //         obj.removeAttribute("disabled");  //重置倒计时按钮样式
            //         $("#btn").html("获取验证码");
            //         countdown = 60;
            //         $('#phone').focus();
            //         return false;
            //     }
            // }  

            if (linkKey == 1) {                                        //当接口控制开启 可走接口交互验证码
                $.post("/clt/user/sendCode.msp", {
                        isH5Test : true, 
                        mobile: phone,
                        countryCode: 86,
                        codeType: 5
                },function(data){
                        console.log(data)
                        if (data.code == '0'){                                 //发送失败 跳出提示 不进行倒计时
                            var msg1= data.msg
                            alert(msg1)
                            clearTimeout(ttt);    
                        }else if(data.code == '1'){                            //发送成功 进入倒计时 按钮持续不可操作 直到cuntdown为0后恢复
                            var msg2 = data.msg
                            alert(msg2)
                            timeoutKey = 1;         //倒计时控制变量 开启
                            linkKey = 0;            //接口关闭                                     
                        }
                }, "json");
            }

            if(timeoutKey == '1' & linkKey != '1'){                //倒计时控制开启  接口控制关闭  此时进行倒计时
                obj.setAttribute("disabled", true);                //不可选中
                $("#btn").html("重新发送(" + countdown + ")");
                countdown--;                                       //数字倒计时
            }

            if (countdown == 0) {                                  //倒计时结束 重置按钮 可重新走接口
                linkKey++                 //开启接口
                timeoutKey--              //关闭倒计时
                obj.removeAttribute("disabled");  //重置倒计时按钮样式
                $("#btn").html("获取验证码");
                countdown = 60;
                return;
            }

            var ttt = setTimeout(function(){
                settime(obj)
            }, 1000) 
        }
    </script>
    
    <!--去除弹窗默认样式  -->
    <script>
        window.alert = function(name){
            var iframe = document.createElement("IFRAME");
            iframe.style.display="none";
            iframe.setAttribute("src", 'data:text/plain,');
            document.documentElement.appendChild(iframe);
            window.frames[0].window.alert(name);
            iframe.parentNode.removeChild(iframe);
        }  
    </script>  
    <script>
        // 返回上一页
        function goback(){
            window.history.go(-1);
        }
    </script>
    <!-- <script src="/js/jquery-2.1.4.min.js" type="text/javascript"></script> -->
</body>
</html>